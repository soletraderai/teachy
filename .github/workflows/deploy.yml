# ===========================================
# Teachy CI/CD Pipeline
# Automated testing, building, and deployment
# ===========================================

name: Deploy to Production

on:
  # Disabled auto-deploy on push - infrastructure not set up yet
  # push:
  #   branches:
  #     - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: 'false'
        type: boolean
      skip_smoke_tests:
        description: 'Skip smoke tests after deployment'
        required: false
        default: 'false'
        type: boolean

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME_API: ${{ github.repository }}/teachy-api
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/teachy-frontend

jobs:
  # ===========================================
  # Job 1: Run Tests
  # ===========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            api/package-lock.json

      - name: Install frontend dependencies
        run: npm ci

      - name: Install API dependencies
        run: cd api && npm ci

      - name: Run frontend lint
        run: npm run lint

      - name: Run API lint
        run: cd api && npm run lint || true

      - name: Run API typecheck
        run: cd api && npm run typecheck

      - name: Run frontend build (validation)
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

  # ===========================================
  # Job 2: Build and Push Docker Images
  # ===========================================
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    permissions:
      contents: read
      packages: write
    outputs:
      api_image: ${{ steps.meta-api.outputs.tags }}
      frontend_image: ${{ steps.meta-frontend.outputs.tags }}
      short_sha: ${{ steps.vars.outputs.short_sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set variables
        id: vars
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME_API }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          file: ./api/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          build-args: |
            VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
            VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
            VITE_API_URL=${{ secrets.VITE_API_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================
  # Job 3: Deploy to Server
  # ===========================================
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          SHORT_SHA: ${{ needs.build-and-push.outputs.short_sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}

            # Backup current state
            echo "$(date): Starting deployment of ${{ needs.build-and-push.outputs.short_sha }}" >> deployments.log

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main

            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull new images
            docker compose -f docker-compose.prod.yml pull

            # Stop and restart services with new images
            docker compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans

            # Wait for services to start
            sleep 10

            # Clean up old images
            docker image prune -f

            # Log successful deployment
            echo "$(date): Successfully deployed ${{ needs.build-and-push.outputs.short_sha }}" >> deployments.log
          ENDSSH

  # ===========================================
  # Job 4: Run Smoke Tests
  # ===========================================
  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ github.event.inputs.skip_smoke_tests != 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for services to stabilize
        run: sleep 30

      - name: Run smoke tests
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          API_URL: ${{ secrets.API_URL }}
        run: |
          chmod +x scripts/smoke-test.sh
          ./scripts/smoke-test.sh

  # ===========================================
  # Job 5: Rollback on Failure
  # ===========================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: ${{ failure() }}
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Execute rollback
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}

            echo "$(date): Initiating rollback due to failed smoke tests" >> deployments.log

            # Revert to previous commit
            git checkout HEAD~1

            # Restart services with previous state
            docker compose -f docker-compose.prod.yml up -d --force-recreate

            echo "$(date): Rollback completed" >> deployments.log
          ENDSSH

      - name: Notify about rollback
        run: |
          echo "::error::Deployment failed smoke tests and was rolled back"
